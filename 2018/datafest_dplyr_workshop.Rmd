---
title: "Data Wrangling With Dplyr"
author: "Karla Villalta"
date: "3/24/2018"
output:
  beamer_presentation: default
  slidy_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(tibble)
library(nycflights13)
```

Workshop data 
========================================================

For this workshop we will be using the flights dataset, which includes the airline on-time data for all flights that departed NYC in 2013.
Also, includes useful 'metadata' on airlines, airports, weather, and planes. The dataset can be found by following these steps:

```{r load_data, eval = FALSE, echo=TRUE}
install.packages('nycflights13')
library(nycflights13)
```

```{r inspect_data, echo = TRUE}
# Data dimensions and format
glimpse(flights)
```

Data
========================================================
This is how our data looks like:
```{r data_samp, echo = TRUE}
# Column names 
names(flights)
head(flights)
```

Think Of Interesting Questions 
========================================================
Some examples are:

- Which airplanes fly the most?
- What are the top 10 most popular destinations?
- What carriers are delayed more often?
- Is there any peak hour?
- Do some days of the week have more flights than others?
- Do some carriers have more delays than others?
- Do longer flights tend to have more delays?

Organize Your Questions 
========================================================
Do some questions seem to be related to each other? Try and group them, and sort them in order of fruitfulness/ease of exploration.

Examples for the flights data :

1. Which planes fly the most?
2. How do the number of flights change over time?
3. Do some carriers have more delays than others?

dplyr 
========================================================
*dplyr* is a powerful R-package to transform and summarize tabular data with rows and columns. 
The package contains a set of functions (or “verbs”) that perform common data manipulation operations such as filtering for rows, selecting specific columns, re-ordering rows, adding new columns and summarizing data.

dplyr vs. Base R Functions
========================================================
*dplyr functions* process faster than base R functions. It is because dplyr functions were written in a computationally efficient manner. They are also more stable in the syntax and better supports data frames than vectors.

How Do I get dplyr?
========================================================
To install do:
```{r install_code, eval = FALSE, echo=TRUE}
install.packages("dplyr")
```

To load do:
```{r load_dplyr, eval=FALSE, echo=TRUE}
library(dplyr)
```

Important Verbs To Remember
========================================================
dplyr verbs | Desciption 
------------|-------------
 select()   | select columns 
 filter()   | filter rows that fulfill a condition 
 arrange()  | sort rows by column 
 mutate()   | create new columns 
 summarise()| summarise (or aggregate) data
 group_by() | groups the data 
 rename()   | rename columns 
 
Helper Functions 
========================================================
Helper        | Desciption 
--------------|-------------
starts_with() | Starts with a prefix
ends_with()   | Select columns that end with a character string
contains()    | Select columns that contain a character string
matches()     | Select columns that match a regular expression
num_range()   | Numerical range like x01, x02
one_of()      | Variables in character vector
everything()  | All variables 

Pipe Operator %>%
========================================================
*dplyr* utilizes pipe operator from another package (magrittr).
All the functions in dplyr package can be used without the pipe operator but the pipe lets to wrap multiple functions together.
For example: You can mutate a column and select a subset of columns in a single dplyr pipeline. 

Example:

```{r ex_1, eval=FALSE, echo=TRUE}
sample_n(select(flights, year, month, carrier, air_time),10)
```
Or
```{r ex_ 2, eval=FALSE, echo=TRUE}
flights %>% select(year, month, carrier, air_time) %>% sample_n(10)
```

Selecting Rows
========================================================
This is something that may come handy when you are exploring your data or when dealing with a large dataset. 

Selecting Random N Rows:
```{r, eval=FALSE, echo=TRUE}
sample_n(flights, 10)
```

Selecting Random Fraction of Rows:
```{r, eval=FALSE, echo=TRUE}
# Randomly selects 20% of the data 
sample_frac(flights, 0.20)
```

Selecting or Dropping variables 
========================================================
You can select the cloumns that you need for your computations by 
using *select()*. Columns can be dropped by adding *-* before the column name:  
```{r, eval=FALSE, echo=TRUE}
flights %>% 
  mutate(total_delay = dep_delay + arr_delay) %>% 
  select(-dep_delay, -arr_delay, -time_hour) %>% 
  head()
```


Which planes fly the most?
========================================================
Tailnum uniquely identifies a plane.

Answer:
========================================================
```{r q_1, eval=TRUE, echo=TRUE}

flights %>%
  group_by(tailnum) %>%
  summarize(num_flights = n(),
            total_air_time = sum(air_time, na.rm = TRUE),
            max_distance = max(distance)) %>%
  arrange(-num_flights, -total_air_time) %>% 
  head()
```

How do the number of flights change over time?
========================================================
You can utilize multiple functions to modify and aggregate variables.

Answer:
========================================================
```{r another_q, echo=TRUE, eval=TRUE}
flights %>%
  mutate(date = paste(year, month, day, sep='-'),
         date = as.Date(date)) %>%
  group_by(date) %>%
  summarise(count = n()) 
```

How do the number of flights change over time?
========================================================
You should use *group_by* to answer this question.

Answer:
========================================================
```{r one_q, echo=TRUE, out.width='600px'}
flight_date <- flights %>%
  mutate(date = paste(year, month, day, sep='-'),
         date = as.Date(date)) %>%
  group_by(date) %>%
  summarise(count = n())

plot(flight_date$date, flight_date$count)
```

How do the number of flights change over time?
========================================================
Regular R functions can piped as well. For example:

```{r, eval=TRUE, echo=TRUE}
select(flights, month) %>%
  table() %>%
  barplot()
```

```{r, eval=TRUE, echo=TRUE, }
select(flights, month) %>%
  table()
```


Do some carriers have more delays than others?
========================================================
Your turn!!

Answer:
========================================================
```{r q_2, echo=TRUE, eval=TRUE}
flights %>%
  select(carrier, arr_delay) %>%
  group_by(carrier) %>%
  summarize(num_flights = n(),
            total_arr_delay = sum(arr_delay, na.rm = TRUE),
            delay_per_flight = total_arr_delay/num_flights) %>%
  arrange(-delay_per_flight) %>%
  head(n = 7)
```


Does destination contribute to arrival delay?
========================================================
```{r q_3, echo=TRUE, eval=TRUE}
flights %>%
  select(dest, arr_delay) %>%
  group_by(dest) %>%
    summarize(num_flights = n(),
            total_arr_delay = sum(arr_delay, na.rm = TRUE),
            delay_per_flight = total_arr_delay / num_flights) %>%
  filter(num_flights > 25) %>%
  arrange(delay_per_flight) %>%
  top_n(5, delay_per_flight)
```


Does destination contribute to arrival delay?
========================================================
Order table by *arr_delay*, and visualize differences between destinations.

```{r, echo=FALSE, out.width='475px'}
flight_tmp <- flights %>%
  select(dest, arr_delay) %>%
  group_by(dest) %>%
    summarize(num_flights = n(),
            total_arr_delay = sum(arr_delay, na.rm = TRUE),
            delay_per_flight = total_arr_delay / num_flights) %>%
  filter(num_flights > 25) %>%
  arrange(delay_per_flight)

plot(sort(flight_tmp$delay_per_flight))
```


Resources 
========================================================
Dplyr cheat sheet can be found [here](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)

##Tutorials 
- General use of dplyr [here](http://genomicsclass.github.io/book/pages/dplyr_tutorial.html) and [here](https://www.listendata.com/2016/08/dplyr-tutorial.html)
- Non-standard-evaluation [here](http://rmhogervorst.nl/cleancode/blog/2016/06/13/NSE_standard_evaluation_dplyr.html)


Thank you!
========================================================

